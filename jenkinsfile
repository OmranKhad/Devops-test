pipeline {
  agent any
  stages {

    stage('Git') {
       steps {
        echo 'Pulling...' 
        git branch: 'omran-khd',
        url : 'https://github.com/OmranKhad/Devops-test.git'
      }
    }
      
    stage('MVN Clean') {
       steps {
        sh "mvn clean"      
      }
    }

      stage('MVN Compile') {
       steps {
        sh "mvn compile"      
      }
    }
    stage('Tests') {
        steps {
         sh 'mvn test'
      }
    }

    stage('MVN Package') {
      steps {
        sh "mvn package"
      }
    }

	stage('Sonarqube Analysis') {
         steps {

         sh "mvn sonar:sonar \
         -Dsonar.projectKey=tpfoyer \
	 -Dsonar.projectKey=tpfoyer \
         -Dsonar.host.url=http://192.168.50.50:9000 \
	 -Dsonar.token=sqp_fdd9a240fde2f8351e685a39b93fcf8c3de9061c"


}
}
	stage('Nexus') {
         steps {
		sh "mvn deploy"
         }
        }

 stage('Docker Image'){
            steps{
                script{
                    sh 'sudo docker build -t omrankhd/tp-foyer:${BUILD_ID} .'
                }
            }
        }
 stage('docker compose down') {
            steps {
                sh "sudo docker compose down"
            }
        }

 stage('Starting Container') {
            steps {
                sh "sudo docker compose up -d"
            }
        }

 //stage('deploy extern') {
 //           steps {
 //             withCredentials([string(credentialsId: 'ngrok_creds', variable: 'Secret')]) {
 //               sh"ngrok config add-authtoken ${Secret}"
 //               sh "ngrok http http://192.168.50.50:8089"
 //           }
 //           }
 //       }
stage('Network scan') {
            steps {
                sh "sudo nmap -F localhost"
            }
        }
 stage('build hello') {
             steps {
                  script{
                     sh 'mkdir -p hello && cd hello'
                     sh 'echo "FROM hello-world " > dockerfile'
                     sh 'sudo docker build -t omrankhd/myhelloworld:${BUILD_ID} .'
                  }
             }
                         }

   stage('Deploy hello') {
             steps {
                 withCredentials([string(credentialsId: 'dockerhub-jenkins-token', variable: 'Secret')]) {
                     sh "docker login -u omrankhd -p ${Secret}"
                     sh 'docker push omrankhd/myhelloworld:${BUILD_ID}'
                 }
             }
                         }
}
}
